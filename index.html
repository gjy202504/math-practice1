<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å£ç®—è®­ç»ƒè¥ ğŸš€</title>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
        :root {
            --primary-color: #FF69B4;
            --secondary-color: #87CEEB;
        }

        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #FFB6C1, #87CEEB);
            margin: 0;
            padding: 0;
        }

        .fixed-header {
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 20px;
        }

        .content-area {
            margin-top: 200px;
            padding: 20px;
            min-height: calc(100vh - 240px);
            overflow-y: auto;
        }

        .settings {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        select, button {
            font-size: 20px;
            padding: 12px 25px;
            margin: 8px;
            border-radius: 30px;
            border: 3px solid var(--primary-color);
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }

        button:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        #timer {
            font-size: 26px;
            color: #FF1493;
            margin: 10px 0;
            display: inline-block;
            padding: 0 25px;
        }

        .problem {
            font-size: 32px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            text-align: left;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
        }

        input {
            font-size: 32px;
            width: 100px;
            height: 50px;
            text-align: center;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            margin-left: 20px;
            padding: 5px;
            transition: all 0.3s;
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="settings">
            <h1 class="rainbow-text">ğŸŒˆ æ™ºèƒ½å£ç®—è®­ç»ƒè¥ ğŸŒˆ</h1>
            <div>
                <select id="count">
                    <option>10</option>
                    <option>20</option>
                    <option>30</option>
                    <option>40</option>
                    <option>50</option>
                </select>

                <select id="range">
                    <option>10ä»¥å†…</option>
                    <option>20ä»¥å†…</option>
                    <option>50ä»¥å†…</option>
                    <option>100ä»¥å†…</option>
                </select>

                <button onclick="generateFromCSV()">ğŸ‰ å¼€å§‹æŒ‘æˆ˜ï¼</button>
                <div id="timer">â° æ—¶é—´ï¼š00:00</div>
            </div>
        </div>
    </div>

    <div class="content-area">
        <div id="problems"></div>
        <div id="result"></div>
    </div>

    <script>
        // CSVæ–‡ä»¶åœ°å€ï¼ˆæ›¿æ¢ä¸ºå®é™…åœ°å€ï¼‰
        const CSV_URL = 'https://gjy202504.github.io/math-practice/questions.csv';
        let startTime, timer, currentQuestions = [];
        const emojis = ['ğŸ¶', 'ğŸ°', 'ğŸ»', 'ğŸ¯', 'ğŸ§', 'ğŸ™', 'ğŸ¦„', 'ğŸ³'];

        // åŠ è½½CSVé¢˜åº“
        async function loadCSV() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                alert('é¢˜åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return [];
            }
        }

        // è§£æCSVæ•°æ®
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const headers = lines[0].split(',');
            return lines.slice(1).map(line => {
                const values = line.split(',');
                return headers.reduce((obj, header, index) => {
                    obj[header.trim()] = values[index]?.trim();
                    return obj;
                }, {});
            });
        }

        // ç”Ÿæˆé¢˜ç›®
        async function generateFromCSV() {
            const allQuestions = await loadCSV();
            const selectedRange = document.getElementById('range').value;
            const requiredCount = parseInt(document.getElementById('count').value);

            // ç­›é€‰é¢˜ç›®
            const filteredQuestions = allQuestions.filter(q => {
                const rangeNum = parseInt(selectedRange.replace('ä»¥å†…', ''));
                return q.type.includes(selectedRange);
            });

            if (filteredQuestions.length < requiredCount) {
                alert(`å½“å‰é¢˜åº“ä¸­${selectedRange}é¢˜ç›®ä¸è¶³`);
                return;
            }

            // éšæœºé€‰é¢˜
            currentQuestions = shuffleArray(filteredQuestions).slice(0, requiredCount);
            renderQuestions(currentQuestions);
        }

        // æ´—ç‰Œç®—æ³•
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // æ¸²æŸ“é¢˜ç›®
        function renderQuestions(questions) {
            let html = '';
            questions.forEach((q, i) => {
                html += `
                    <div class="problem">
                        <span class="emoji">${emojis[i%emojis.length]}</span>
                        ${q.a} ${q.operator} ${q.b} = 
                        <input type="number" tabindex="${i+1}">
                    </div>
                `;
            });

            document.getElementById('problems').innerHTML = html;
            document.getElementById('result').innerHTML = '';
            startTimer();
            
            const firstInput = document.querySelector('input');
            firstInput && firstInput.focus();

            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('keydown', handleEnter);
                input.addEventListener('input', validateNumber);
            });
        }

        // è¾“å…¥éªŒè¯
        function validateNumber(e) {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }

        // å›è½¦å¤„ç†
        function handleEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const inputs = Array.from(document.querySelectorAll('input'));
                const currentIndex = inputs.indexOf(event.target);
                
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                } else {
                    checkAnswers();
                }
            }
        }

        // è®¡æ—¶å™¨
        function startTimer() {
            startTime = Date.now();
            timer = setInterval(() => {
                const sec = Math.floor((Date.now()-startTime)/1000);
                document.getElementById('timer').innerHTML = 
                    `â° æ—¶é—´ï¼š${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
            }, 1000);
        }

        // æ‰¹æ”¹ç­”æ¡ˆ
        function checkAnswers() {
            clearInterval(timer);
            const inputs = document.querySelectorAll('input');
            let correct = 0;
            let wrongList = [];

            inputs.forEach((input, index) => {
                const question = currentQuestions[index];
                const userAnswer = parseInt(input.value);
                
                if(userAnswer === parseInt(question.answer)) {
                    correct++;
                    input.style.backgroundColor = '#98FB98';
                } else {
                    wrongList.push(`<li>${question.a} ${question.operator} ${question.b} = ${question.answer}ï¼ˆä½ çš„ç­”æ¡ˆï¼š${input.value}ï¼‰</li>`);
                    input.style.backgroundColor = '#FFB6C1';
                }
                input.disabled = true;
            });

            const timeUsed = document.getElementById('timer').textContent;
            const resultHTML = `
                <div class="result-box">
                    <h3>ğŸ‰ å®Œæˆå•¦ï¼</h3>
                    <p>å¾—åˆ†ï¼š<span class="rainbow-text">${correct}</span>/${inputs.length}</p>
                    <p>ç”¨æ—¶ï¼š${timeUsed}</p>
                    ${wrongList.length ? `
                        <p>éœ€è¦è®¢æ­£çš„é¢˜ç›®ï¼š</p>
                        <ul>${wrongList.join('')}</ul>
                        <button onclick="generateFromCSV()">ğŸ”„ é‡æ–°æŒ‘æˆ˜</button>
                    ` : '<p class="emoji">ğŸ‰ å…¨å¯¹å•¦ï¼å¤ªæ£’äº†ï¼</p>'}
                </div>
            `;

            document.getElementById('result').innerHTML = resultHTML;
            document.getElementById('result').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>